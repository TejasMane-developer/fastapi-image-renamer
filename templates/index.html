<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Image Renamer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
  <div class="container py-4">
    <h2 class="text-center mb-4">üñºÔ∏è Image Renamer Tool</h2>
    <div class="mt-3 text-end">
      <button id="cleanupBtn" class="btn btn-danger btn-sm shadow-sm mb-3">
        üóëÔ∏è Delete All Temp Files
      </button>
    </div>

    <!-- Upload Form -->
    <form id="uploadForm" class="card p-2 shadow-sm mb-3">
      <div class="mb-2">
        <label for="zipFile" class="form-label mb-1">Upload Zip File</label>
        <input type="file" class="form-control form-control-sm" id="zipFile" name="file" accept=".zip" required>
      </div>

      <div class="mb-3">
        <label for="renameMap" class="form-label fw-semibold">üîÑ Rename Map (JSON)</label>
        <textarea class="form-control form-control-sm rounded-3 shadow-sm font-monospace" id="renameMap"
          name="rename_map" rows="10" placeholder='{
        "round": "A01",
        "asscher": "B01",
        "cushion": "C01",
        "princess": "D01",
        "emerald": "E01",
        "oval": "F01",
        "radiant": "G01",
        "marquise": "H01",
        "heart": "I01",
        "pear": "J01"
      }' required></textarea>

        <div class="d-flex justify-content-end mt-2">
          <button class="btn btn-sm btn-outline-primary px-3 shadow-sm" type="button" id="copySample">
            üìã Copy Sample JSON
          </button>
        </div>
        <div class="form-text text-muted mt-1">
          Enter your shape-to-code mapping in valid JSON format or copy the sample above.
        </div>
      </div>

      <button type="submit" class="btn btn-primary btn-sm w-100">Upload & Rename</button>

      <div id="loader" class="text-center mt-3 d-none">
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Processing...</span></div>
        <div class="mt-1 small text-muted">Processing...</div>
      </div>
    </form>

    <!-- Download Link -->
    <div id="downloadLink"></div>

    <!-- Renamed Files Table -->
    <div class="card p-3 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Renamed Files</h5>
        <div>
          <label class="form-label mb-0 me-2">Rows per page:</label>
          <select id="rowsPerPage" class="form-select form-select-sm d-inline-block w-auto">
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th scope="col">Image</th>
              <th scope="col">Old Name</th>
              <th scope="col">New Name</th>
            </tr>
          </thead>
          <tbody id="resultTableBody"></tbody>
        </table>
      </div>
      <nav>
        <ul class="pagination justify-content-center mb-0" id="pagination"></ul>
      </nav>
    </div>
  </div>

  <!-- Image Popup Modal -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content bg-dark">
        <div class="modal-header border-0">
          <h5 class="modal-title text-white">Preview</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body d-flex justify-content-center align-items-center">
          <img id="modalImage" src="" class="img-fluid rounded shadow" alt="Preview">
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index:1055">
    <div id="errorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive"
      aria-atomic="true" data-bs-delay="5000">
      <div class="d-flex">
        <div class="toast-body" id="errorToastMessage">Error occurred</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive"
      aria-atomic="true" data-bs-delay="5000">
      <div class="d-flex">
        <div class="toast-body" id="successToastMessage">Success</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    const uploadForm = document.getElementById("uploadForm");
    const loader = document.getElementById("loader");
    const downloadLink = document.getElementById("downloadLink");
    const tbody = document.getElementById("resultTableBody");
    const pagination = document.getElementById("pagination");
    const rowsPerPageSelect = document.getElementById("rowsPerPage");
    const renameMap = document.getElementById("renameMap");
    const cleanupBtn = document.getElementById("cleanupBtn");

    const imageModal = new bootstrap.Modal(document.getElementById("imageModal"));
    const modalImage = document.getElementById("modalImage");

    // Zoom effect (modal scroll)
    let zoomLevel = 1;
    modalImage.addEventListener("wheel", (e) => {
      e.preventDefault();
      zoomLevel += e.deltaY * -0.001;
      zoomLevel = Math.min(Math.max(zoomLevel, 1), 5); // limit 1x - 5x
      modalImage.style.transform = `scale(${zoomLevel})`;
    });
    modalImage.addEventListener("click", () => {
      zoomLevel = 1;
      modalImage.style.transform = "scale(1)";
    });

    // Hover magnifier (table images)
    document.addEventListener("mouseover", (e) => {
      if (e.target.classList.contains("img-thumbnail")) {
        e.target.style.transition = "transform 0.2s ease";
        e.target.style.transform = "scale(2)";
        e.target.style.zIndex = "1000";
        e.target.style.position = "relative";
      }
    });
    document.addEventListener("mouseout", (e) => {
      if (e.target.classList.contains("img-thumbnail")) {
        e.target.style.transform = "scale(1)";
        e.target.style.zIndex = "";
        e.target.style.position = "";
      }
    });

    // Toast helpers
    function showErrorToast(message) {
      document.getElementById("errorToastMessage").innerText = message;
      new bootstrap.Toast(document.getElementById("errorToast")).show();
    }
    function showSuccessToast(message) {
      document.getElementById("successToastMessage").innerText = message;
      new bootstrap.Toast(document.getElementById("successToast")).show();
    }

    // Upload & rename
    uploadForm.onsubmit = async (e) => {
      e.preventDefault();
      loader.classList.remove("d-none");
      downloadLink.innerHTML = "";
      tbody.innerHTML = "";
      pagination.innerHTML = "";

      const form = new FormData(uploadForm);
      form.set("rename_map", renameMap.value);

      try {
        const res = await fetch("/upload", { method: "POST", body: form });
        const data = await res.json();
        if (data.error) return showErrorToast(data.error);

        // Download button
        downloadLink.innerHTML = `
          <div class="alert alert-success">
            ‚úÖ <a href="${data.download_url}" target="_blank" class="alert-link">Download Renamed Zip</a>
          </div>`;

        const files = data.renamed_files || [];
        let resultsPerPage = parseInt(rowsPerPageSelect.value);
        let currentPage = 1;

        const renderTablePage = (page) => {
          tbody.innerHTML = "";
          files.slice((page - 1) * resultsPerPage, page * resultsPerPage).forEach(file => {
            tbody.insertAdjacentHTML("beforeend", `
              <tr>
                <td>
                  <img src="${file.url}" class="img-thumbnail img-clickable" alt="${file.new}" data-src="${file.url}">
                </td>
                <td>${file.old}</td>
                <td>${file.new}</td>
              </tr>`);
          });

          // Attach click listeners for popup
          document.querySelectorAll(".img-clickable").forEach(img => {
            img.addEventListener("click", () => {
              modalImage.src = img.dataset.src;
              zoomLevel = 1;
              modalImage.style.transform = "scale(1)";
              imageModal.show();
            });
          });
        };

        const renderPagination = () => {
          pagination.innerHTML = "";
          const pageCount = Math.ceil(files.length / resultsPerPage);
          if (pageCount <= 1) return;

          const createPageItem = (label, page, disabled = false, active = false) => `
            <li class="page-item ${disabled ? "disabled" : ""} ${active ? "active" : ""}">
              <button class="page-link">${label}</button>
            </li>`;

          pagination.insertAdjacentHTML("beforeend", createPageItem("¬´", currentPage - 1, currentPage === 1));
          if (currentPage > 1) pagination.lastChild.querySelector("button").onclick = () => {
            currentPage--; renderTablePage(currentPage); renderPagination();
          };

          let start = Math.max(1, currentPage - 2);
          let end = Math.min(pageCount, currentPage + 2);

          if (start > 1) {
            pagination.insertAdjacentHTML("beforeend", createPageItem(1, 1, false, currentPage === 1));
            if (start > 2) pagination.insertAdjacentHTML("beforeend", `<li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>`);
          }

          for (let i = start; i <= end; i++) {
            pagination.insertAdjacentHTML("beforeend", createPageItem(i, i, false, i === currentPage));
            if (i !== currentPage) pagination.lastChild.querySelector("button").onclick = () => {
              currentPage = i; renderTablePage(currentPage); renderPagination();
            };
          }

          if (end < pageCount) {
            if (end < pageCount - 1) pagination.insertAdjacentHTML("beforeend", `<li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>`);
            pagination.insertAdjacentHTML("beforeend", createPageItem(pageCount, pageCount, false, currentPage === pageCount));
            if (currentPage !== pageCount) pagination.lastChild.querySelector("button").onclick = () => {
              currentPage = pageCount; renderTablePage(currentPage); renderPagination();
            };
          }

          pagination.insertAdjacentHTML("beforeend", createPageItem("¬ª", currentPage + 1, currentPage === pageCount));
          if (currentPage < pageCount) pagination.lastChild.querySelector("button").onclick = () => {
            currentPage++; renderTablePage(currentPage); renderPagination();
          };
        };

        rowsPerPageSelect.addEventListener("change", () => {
          resultsPerPage = parseInt(rowsPerPageSelect.value);
          currentPage = 1;
          renderTablePage(currentPage);
          renderPagination();
        });

        renderTablePage(currentPage);
        renderPagination();

      } catch {
        showErrorToast("Something went wrong. Please try again.");
      } finally {
        loader.classList.add("d-none");
      }
    };

    // Copy Sample JSON
    document.getElementById("copySample").addEventListener("click", function () {
      const sampleJson = `{
  "round": "A01",
  "asscher": "B01",
  "cushion": "C01",
  "princess": "D01",
  "emerald": "E01",
  "oval": "F01",
  "radiant": "G01",
  "marquise": "H01",
  "heart": "I01",
  "pear": "J01"
}`;

      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(sampleJson)
          .then(() => {
            updateBtn(this);
          })
          .catch(err => {
            console.error("Clipboard API failed", err);
            fallbackCopy(sampleJson, this);
          });
      } else {
        fallbackCopy(sampleJson, this);
      }
    });

    function fallbackCopy(text, btn) {
      const textarea = document.createElement("textarea");
      textarea.value = text;
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand("copy");
        updateBtn(btn);
      } catch (err) {
        console.error("Fallback copy failed", err);
      }
      document.body.removeChild(textarea);
    }

    function updateBtn(btn) {
      btn.innerText = "‚úÖ Copied!";
      setTimeout(() => (btn.innerText = "üìã Copy Sample JSON"), 2000);
    }

    // Auto-resize textarea
    renameMap.addEventListener("input", () => {
      renameMap.style.height = "auto";
      renameMap.style.height = renameMap.scrollHeight + "px";
    });

    // Cleanup button
    cleanupBtn.addEventListener("click", async () => {
      if (!confirm("Are you sure you want to delete all temp, preview, and result files?")) return;
      try {
        const res = await fetch("/cleanup", { method: "DELETE" });
        const data = await res.json();
        if (data.error) {
          showErrorToast(data.error);
        } else {
          showSuccessToast(data.message);
        }
      } catch {
        showErrorToast("Cleanup failed. Please try again.");
      }
    });
  </script>
</body>

</html>
